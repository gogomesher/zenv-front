const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chain_config-D8DYnceI.js","assets/chain_config-6v70HCvJ.css"])))=>i.map(i=>d[i]);
import{m as T,l as P,_ as Q,n as Z}from"./chain_config-D8DYnceI.js";let u=null,g,F,c=null,m=null;T.subscribeState(async e=>{console.log("AppKit State:",e);let t=e.isConnected,s=e.address,a=e.selectedNetworkId;if(t===void 0||s===void 0)try{const n=T.getAccount();console.log("Fetched account info:",n),n&&(t=n.isConnected,s=n.address)}catch(n){console.warn("Failed to get account info:",n)}if(t&&s){let n=a,o=null;if(typeof a=="string"&&a.includes(":")){const f=a.split(":");f[0]==="eip155"&&(n=Number(f[1]))}else n=Number(a);typeof a=="string"&&a.startsWith("solana")?(n="solana",o=T.getProvider("solana")):typeof a=="string"&&(a.startsWith("ton")||a==="-239")?(n="ton",o=T.getProvider("ton")):isNaN(n)||(o=T.getProvider("eip155")),await w(o,s,n)}else j()});async function w(e,t,s){c=s,u=t,console.log("Connected account:",u);const a=document.querySelector(".verify-btn");a&&(a.textContent=u.substring(0,6)+"..."+u.substring(u.length-4));const n=P[c],o=document.getElementById("network-display");if(!n){console.warn(`Unsupported network: ${c}.`),i("不支持的网络，请切换到支持的链","error"),o&&(o.textContent="未知网络",o.style.display="inline-block");return}o&&(o.textContent=n.name,o.style.display="inline-block"),m=n.contractAddress,console.log(`Connected to ${n.name} (${c}). Contract: ${m}`),m||i(`该网络 (${n.name}) 暂未部署合约`,"warning"),n.type==="evm"?typeof ethers<"u"&&e&&(g=new ethers.providers.Web3Provider(e,"any"),F=g.getSigner(),e.on&&e.on("chainChanged",f=>{window.location.reload()})):n.type==="solana"?(console.log("Connected to Solana"),window.solanaProvider=e):n.type==="ton"&&(console.log("Connected to TON"),window.tonProvider=e),i(`已连接到 ${n.name}`,"success")}function j(){console.log("Disconnected"),u=null,c=null,m=null;const e=document.querySelector(".verify-btn");e&&(e.textContent="连接钱包");const t=document.getElementById("network-display");t&&(t.style.display="none")}document.addEventListener("DOMContentLoaded",async function(){const e=document.getElementById("menu-toggle"),t=document.getElementById("nav-menu");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("active")});const s=new Go,n=await(await fetch("https://cdn.zionfhe.ai/zenv/sha256.wasm")).arrayBuffer(),o=await WebAssembly.instantiate(n,s.importObject);s.run(o.instance);function f(){const p=new URLSearchParams(window.location.search);if(p.get("envelopeId"))return p.get("envelopeId");if(p.get("envelopeid"))return p.get("envelopeid");if(window.location.hash){const r=window.location.hash.substring(1),d=new URLSearchParams(r);if(d.get("envelopeId"))return d.get("envelopeId");if(d.get("envelopeid"))return d.get("envelopeid");if(r.includes("?")){const M=r.split("?")[1],y=new URLSearchParams(M);if(y.get("envelopeId"))return y.get("envelopeId");if(y.get("envelopeid"))return y.get("envelopeid")}}return null}const k=f();k&&(document.getElementById("envelope-id").value=k),document.querySelector(".verify-btn").addEventListener("click",function(p){p.preventDefault(),X()}),document.getElementById("receive-form").addEventListener("submit",async function(p){p.preventDefault();const r=document.getElementById("envelope-id").value,d=document.getElementById("password").value,y=await(await fetch("https://cdn.zionfhe.ai/zenv/pkb")).arrayBuffer(),L=new Uint8Array(y),R="0x"+goSha256(d,L);if(!r){i("请输入红包 ID","error");return}if(!u){i("请先连接钱包","error");return}if(!m){i("当前网络暂不支持或未配置合约地址","error");return}document.getElementById("error-info").style.display="none",document.getElementById("asset-info").style.display="none";const v=document.querySelector(".submit-btn"),O=v.innerHTML;v.innerHTML='<i class="fas fa-spinner fa-spin"></i> 正在领取...',v.disabled=!0;try{const l=new ethers.Contract(m,ee,F);i("正在验证红包ID...","info");const D=await l.nextEnvelopeId();if(parseInt(r)<=0||parseInt(r)>=D){i("无效的红包 ID","error");return}const h=await g.getBlockNumber();console.log("Starting claim at block:",h);const W=await l.claimEnvelopeWithPassword(r,R);i("已提交领取请求，等待交易确认...","info"),await W.wait(),i("交易已确认，等待后端验证...","info");let B;const _=40;let I=0;await new Promise(($,A)=>{const E=setInterval(async()=>{I++;try{console.log(`Polling attempt ${I}/${_}...`);const x=ethers.utils.hexZeroPad(ethers.BigNumber.from(r).toHexString(),32),z=l.filters.EnvelopeClaimed(x),C=(await l.queryFilter(z,h)).find(b=>b.args.claimer.toLowerCase()===u.toLowerCase());if(C){console.log("Found my claim event:",C),B=C.args.amount,clearInterval(E),$();return}const G=l.filters.PasswordVerificationFailed(),S=(await l.queryFilter(G,h)).find(b=>b.args.envelopeId.toString()===r);if(S){console.log("Found failure event:",S),clearInterval(E);const b=document.getElementById("error-info"),K=document.getElementById("error-details");K.innerHTML="口令验证失败，请检查口令是否正确。",b.style.display="block",A(new Error("口令验证失败"));return}I>=_&&(clearInterval(E),A(new Error("领取超时，未检测到领取事件。请检查钱包余额。")))}catch(x){console.error("Polling error:",x)}},3e3)});const H=await l.getEnvelopeInfo(r),U=await J(H.tokenAddress),q=document.getElementById("asset-info"),V=document.getElementById("asset-details");let N=`代币: ${U}<br>
                               数量: ${ethers.utils.formatUnits(B,18)}`;V.innerHTML=N,q.style.display="block",i("红包领取成功！","success")}catch(l){console.error("领取红包失败:",l),i(`领取红包失败: ${l.message}`,"error")}finally{v.innerHTML=O,v.disabled=!1}})});async function J(e){if(e==="0x0000000000000000000000000000000000000000"){const t=P[c];return t?t.currency:"ETH"}try{const t=["function name() view returns (string)"];return await new ethers.Contract(e,t,g).name()}catch(t){return console.error("Could not fetch token name for",e,t),e}}async function X(){const e=document.getElementById("wallet-select-modal");e&&(e.style.display="flex")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("wallet-select-modal"),t=document.getElementById("close-select-modal"),s=document.getElementById("select-appkit"),a=document.getElementById("select-tron");t&&t.addEventListener("click",()=>{e.style.display="none"}),s&&s.addEventListener("click",()=>{e.style.display="none",Q(()=>import("./chain_config-D8DYnceI.js").then(n=>n.dq),__vite__mapDeps([0,1])).then(n=>{n.modal?n.modal.open():i("Web3Modal 初始化失败","error")})}),a&&a.addEventListener("click",async()=>{e.style.display="none",await Y()}),e&&e.addEventListener("click",n=>{n.target===e&&(e.style.display="none")})});async function Y(){try{if(window.tronWeb&&window.tronWeb.ready){console.log("TronLink detected and ready");const t=window.tronWeb.defaultAddress.base58;if(t){await w(null,t,"tron");return}}else if(window.tronWeb&&(console.log("TronLink detected but not ready, requesting accounts..."),(await window.tronWeb.request({method:"tron_requestAccounts"})).code===200)){setTimeout(async()=>{window.tronWeb.defaultAddress.base58&&await w(null,window.tronWeb.defaultAddress.base58,"tron")},500);return}console.log("TronLink not available or failed, falling back to WalletConnect");const e=await Z();e&&await w(null,e,"tron")}catch(e){console.error("Tron connection error:",e),i("连接波场失败: "+e.message,"error")}}function i(e,t){alert(`${t.toUpperCase()}: ${e}`)}const ee=[{inputs:[{internalType:"address",name:"_verifier",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{inputs:[],name:"ECDSAInvalidSignature",type:"error"},{inputs:[{internalType:"uint256",name:"length",type:"uint256"}],name:"ECDSAInvalidSignatureLength",type:"error"},{inputs:[{internalType:"bytes32",name:"s",type:"bytes32"}],name:"ECDSAInvalidSignatureS",type:"error"},{inputs:[{internalType:"address",name:"owner",type:"address"}],name:"OwnableInvalidOwner",type:"error"},{inputs:[{internalType:"address",name:"account",type:"address"}],name:"OwnableUnauthorizedAccount",type:"error"},{inputs:[{internalType:"address",name:"token",type:"address"}],name:"SafeERC20FailedOperation",type:"error"},{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"envelopeId",type:"uint256"},{indexed:!0,internalType:"address",name:"claimer",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"EnvelopeClaimed",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"envelopeId",type:"uint256"},{indexed:!0,internalType:"address",name:"creator",type:"address"},{indexed:!1,internalType:"address",name:"tokenAddress",type:"address"},{indexed:!1,internalType:"uint256",name:"expiresAt",type:"uint256"},{indexed:!1,internalType:"uint256",name:"numberOfRecipients",type:"uint256"},{indexed:!1,internalType:"uint8",name:"distributionType",type:"uint8"}],name:"EnvelopeCreated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"envelopeId",type:"uint256"}],name:"EnvelopeFullyClaimed",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"envelopeId",type:"uint256"},{indexed:!0,internalType:"address",name:"recoverer",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"EnvelopeRecovered",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"uint256",name:"oldValidity",type:"uint256"},{indexed:!1,internalType:"uint256",name:"newValidity",type:"uint256"}],name:"EnvelopeValidityUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"previousOwner",type:"address"},{indexed:!0,internalType:"address",name:"newOwner",type:"address"}],name:"OwnershipTransferred",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"requestHash",type:"bytes32"},{indexed:!1,internalType:"uint256",name:"envelopeId",type:"uint256"}],name:"PasswordVerificationFailed",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"claimer",type:"address"},{indexed:!1,internalType:"uint256",name:"envelopeId",type:"uint256"},{indexed:!1,internalType:"bytes",name:"passwordHash",type:"bytes"},{indexed:!1,internalType:"bytes",name:"encryptedPassword",type:"bytes"},{indexed:!1,internalType:"bytes32",name:"requestHash",type:"bytes32"}],name:"PasswordVerificationWithClaimRequested",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"account",type:"address"}],name:"Paused",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"uint256",name:"oldRate",type:"uint256"},{indexed:!1,internalType:"uint256",name:"newRate",type:"uint256"}],name:"ServiceFeeRateUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"uint256",name:"oldFee",type:"uint256"},{indexed:!1,internalType:"uint256",name:"newFee",type:"uint256"}],name:"ServiceFeeUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"owner",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"ServiceFeeWithdrawn",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"account",type:"address"}],name:"Unpaused",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"oldVerifier",type:"address"},{indexed:!0,internalType:"address",name:"newVerifier",type:"address"}],name:"VerifierUpdated",type:"event"},{inputs:[{internalType:"uint256",name:"_envelopeId",type:"uint256"}],name:"autoReturnExpiredEnvelope",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"_envelopeId",type:"uint256"},{internalType:"bytes",name:"_encryptedPassword",type:"bytes"}],name:"claimEnvelopeWithPassword",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{components:[{internalType:"uint256",name:"envelopeId",type:"uint256"},{internalType:"bytes32",name:"requestHash",type:"bytes32"},{internalType:"uint256",name:"amount",type:"uint256"}],internalType:"struct zEnvelope.Claim",name:"_claim",type:"tuple"},{internalType:"bytes",name:"_signature",type:"bytes"}],name:"confirmClaimWithPassword",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_tokenAddress",type:"address"},{internalType:"uint256",name:"_amount",type:"uint256"},{internalType:"bytes",name:"_passwordHash",type:"bytes"},{internalType:"uint256",name:"_validity",type:"uint256"},{internalType:"uint256",name:"_numberOfRecipients",type:"uint256"},{internalType:"uint8",name:"_distributionType",type:"uint8"}],name:"createERC20Envelope",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"payable",type:"function"},{inputs:[{internalType:"bytes",name:"_passwordHash",type:"bytes"},{internalType:"uint256",name:"_validity",type:"uint256"},{internalType:"uint256",name:"_numberOfRecipients",type:"uint256"},{internalType:"uint8",name:"_distributionType",type:"uint8"}],name:"createEnvelope",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"payable",type:"function"},{inputs:[],name:"envelopeValidity",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"envelopes",outputs:[{internalType:"address",name:"creator",type:"address"},{internalType:"bytes",name:"passwordHash",type:"bytes"},{internalType:"address",name:"tokenAddress",type:"address"},{internalType:"uint256",name:"totalAmount",type:"uint256"},{internalType:"uint256",name:"remainingAmount",type:"uint256"},{internalType:"bool",name:"claimed",type:"bool"},{internalType:"uint256",name:"createdAt",type:"uint256"},{internalType:"uint256",name:"expiresAt",type:"uint256"},{internalType:"uint256",name:"numberOfRecipients",type:"uint256"},{internalType:"uint256",name:"claimedRecipientsCount",type:"uint256"},{internalType:"uint8",name:"distributionType",type:"uint8"}],stateMutability:"view",type:"function"},{inputs:[],name:"erc20ServiceFeeRate",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"_requestHash",type:"bytes32"},{internalType:"uint256",name:"_envelopeId",type:"uint256"}],name:"failClaim",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"_envelopeId",type:"uint256"}],name:"getEnvelopeInfo",outputs:[{components:[{internalType:"address",name:"creator",type:"address"},{internalType:"bytes",name:"passwordHash",type:"bytes"},{internalType:"address",name:"tokenAddress",type:"address"},{internalType:"uint256",name:"totalAmount",type:"uint256"},{internalType:"uint256",name:"remainingAmount",type:"uint256"},{internalType:"bool",name:"claimed",type:"bool"},{internalType:"uint256",name:"createdAt",type:"uint256"},{internalType:"uint256",name:"expiresAt",type:"uint256"},{internalType:"uint256",name:"numberOfRecipients",type:"uint256"},{internalType:"uint256",name:"claimedRecipientsCount",type:"uint256"},{internalType:"uint8",name:"distributionType",type:"uint8"}],internalType:"struct zEnvelope.Envelope",name:"",type:"tuple"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"",type:"bytes32"}],name:"hasClaimed",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[],name:"nextEnvelopeId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"owner",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"pause",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"paused",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"",type:"bytes32"}],name:"pendingClaims",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"_envelopeId",type:"uint256"}],name:"recoverUnclaimedEnvelope",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"renounceOwnership",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"serviceFee",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"_rate",type:"uint256"}],name:"setERC20ServiceFeeRate",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"_serviceFee",type:"uint256"}],name:"setServiceFee",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"newOwner",type:"address"}],name:"transferOwnership",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"unpause",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"_newValidity",type:"uint256"}],name:"updateEnvelopeValidity",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_newVerifier",type:"address"}],name:"updateVerifier",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"verifier",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"withdrawServiceFee",outputs:[],stateMutability:"nonpayable",type:"function"}];
